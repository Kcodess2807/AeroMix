<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
</head>

<body style="margin: 0; padding: 0;">
  <div style="position: relative;">
    <canvas id="output_canvas" style="position: absolute; left: 0px; top: 0px;"></canvas>
    <video id="input_video" style="display: none;"></video>
  </div>
  <script>
    // Set up MediaPipe Holistic
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    function onResults(results) {
      // Clear the canvas
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      
      // Draw the video frame
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
      
      // Draw the pose landmarks
      if (results.poseLandmarks) {
        drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                      {color: '#00FF00', lineWidth: 4});
        drawLandmarks(canvasCtx, results.poseLandmarks,
                      {color: '#FF0000', lineWidth: 2});
      }
      
      // Draw the hand landmarks
      if (results.leftHandLandmarks) {
        drawConnectors(canvasCtx, results.leftHandLandmarks, HAND_CONNECTIONS,
                      {color: '#CC0000', lineWidth: 5});
        drawLandmarks(canvasCtx, results.leftHandLandmarks,
                      {color: '#00FF00', lineWidth: 2});
      }
      if (results.rightHandLandmarks) {
        drawConnectors(canvasCtx, results.rightHandLandmarks, HAND_CONNECTIONS,
                      {color: '#00CC00', lineWidth: 5});
        drawLandmarks(canvasCtx, results.rightHandLandmarks,
                      {color: '#FF0000', lineWidth: 2});
      }
      
      // Format landmarks as JSON for OSC
      const landmarks = {
        pose: results.poseLandmarks || [],
        left_hand: results.leftHandLandmarks || [],
        right_hand: results.rightHandLandmarks || []
      };
      
      // Send landmarks to Max/MSP
      try {
        window.max.outlet("landmarks", JSON.stringify(landmarks));
      } catch (e) {
        console.error("Error sending to Max:", e);
      }
      
      canvasCtx.restore();
    }
    
    const holistic = new Holistic({locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
    }});
    
    holistic.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      smoothSegmentation: false,
      refineFaceLandmarks: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    
    holistic.onResults(onResults);
    
    // Set up camera
    function setupCamera() {
      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await holistic.send({image: videoElement});
        },
        width: 640,
        height: 480
      });
      camera.start();
    }
    
    // Resize canvas when window size changes
    function resizeCanvas() {
      canvasElement.width = window.innerWidth;
      canvasElement.height = window.innerHeight;
    }
    
    window.addEventListener('load', () => {
      resizeCanvas();
      setupCamera();
    });
    
    window.addEventListener('resize', resizeCanvas);
  </script>
</body>
</html>
